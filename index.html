<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dice Trading Terminal Pro</title>
<style>
body{font-family:Arial;background:#111;color:#eee}
.container{display:flex}
.left{width:60%}
.right{width:40%;padding-left:20px}
button{margin:3px;padding:6px 10px}
.panel{background:#1c1c1c;padding:10px;margin-top:10px}
.green{color:#4caf50}
.orange{color:#ff9800}
.red{color:#f44336}
.small{color:#03a9f4}
.big{color:#ff5722}
.trendBox{display:flex;flex-wrap:wrap;max-width:300px}
.trendItem{width:12px;height:12px;margin:2px}
.win{background:#4caf50}
.lose{background:#f44336}
.skip{background:#777}
</style>
</head>
<body>

<h2>Dice Trading Terminal Pro</h2>

<div>
初始資金: <input type="number" id="startMoney" value="10000">
<button onclick="init()">啟動</button>
</div>

<div class="container">

<div class="left">

<h3>輸入骰子</h3>
<div id="diceBtns"></div>
<button onclick="submitRound()">送出</button>

<div class="panel">
<h3>預測</h3>
<div id="prediction"></div>
<div id="accuracy"></div>
</div>

<div class="panel">
<h3>特殊機率</h3>
<div id="specialProb"></div>
<div id="intervalHistory"></div>
</div>

<div class="panel">
<h3>交易面板</h3>
<div id="tradePanel"></div>
</div>

</div>

<div class="right">

<div class="panel">
<h3>命中趨勢 (最近40)</h3>
<div class="trendBox" id="trend"></div>
</div>

<div class="panel">
<h3>回測模擬</h3>
局數: <input type="number" id="simRounds" value="500">
<button onclick="runSimulation()">開始回測</button>
<div id="simResult"></div>
</div>

</div>

</div>

<script>

let history=[]
let bankroll=0
let peak=0
let wins=0
let losses=0
let trend=[]
let currentPrediction=null
let lastSpecialIndex=-1
let specialIntervals=[]
let consecutiveWin=0
let consecutiveLose=0
let lockRounds=0

function init(){
  bankroll=parseFloat(document.getElementById("startMoney").value)
  peak=bankroll
  history=[]
  wins=0
  losses=0
  trend=[]
  specialIntervals=[]
  lastSpecialIndex=-1
  consecutiveWin=0
  consecutiveLose=0
  lockRounds=0
  renderDiceButtons()
  updateUI()
}

function renderDiceButtons(){
  let div=document.getElementById("diceBtns")
  div.innerHTML=""
  for(let i=1;i<=6;i++){
    for(let j=1;j<=6;j++){
      for(let k=1;k<=6;k++){
        let b=document.createElement("button")
        b.innerText=`${i}${j}${k}`
        b.onclick=()=>selectDice([i,j,k])
        div.appendChild(b)
      }
    }
  }
}

let selected=null
function selectDice(d){selected=d}

function submitRound(){
  if(!selected) return
  processRound(selected)
  selected=null
}

function processRound(dice){

  let sum=dice[0]+dice[1]+dice[2]
  let isTriple=(dice[0]==dice[1] && dice[1]==dice[2]) || sum==17
  let size=sum>=11?"big":"small"

  history.push({dice,sum,isTriple,size})

  if(isTriple){
    if(lastSpecialIndex!=-1){
      specialIntervals.unshift(history.length-1-lastSpecialIndex)
      if(specialIntervals.length>10) specialIntervals.pop()
    }
    lastSpecialIndex=history.length-1
  }

  let signal=evaluateSignal()
  let betSize=calcBet(signal)

  let result="skip"

  if(lockRounds>0){
    lockRounds--
  }else if(signal!="no"){
    if(currentPrediction==size){
      bankroll+=betSize
      wins++
      consecutiveWin++
      consecutiveLose=0
      result="win"
    }else{
      bankroll-=betSize
      losses++
      consecutiveLose++
      consecutiveWin=0
      result="lose"
    }
  }

  if(consecutiveLose>=4){
    lockRounds=20
  }

  if(bankroll>peak) peak=bankroll

  trend.unshift(result)
  if(trend.length>40) trend.pop()

  updateUI()
}

function evaluateSignal(){

  if(history.length<5) return "no"

  let last30=history.slice(-30)
  let bigCount=last30.filter(x=>x.size=="big").length
  let smallCount=30-bigCount

  let momentum=0
  let recent=history.slice(-5)
  for(let i=1;i<recent.length;i++){
    if(recent[i].size==recent[i-1].size) momentum++
  }

  let specialProb=calcSpecialProb()

  let edge=Math.abs(bigCount-smallCount)/30

  if(specialProb>0.07) return "strong"
  if(edge>0.2) return "medium"
  if(momentum>=3) return "weak"

  return "no"
}

function calcSpecialProb(){
  let base=0.0463
  if(lastSpecialIndex==-1) return base
  let gap=history.length-1-lastSpecialIndex
  if([1,3,5,10,14,16,18].includes(gap)) base+=0.02
  if(gap>20) base+=0.015
  return base
}

function calcBet(level){
  if(level=="strong") return bankroll*0.03
  if(level=="medium") return bankroll*0.02
  if(level=="weak") return bankroll*0.01
  return 0
}

function updateUI(){

  let special=calcSpecialProb()
  let specialColor="green"
  if(special>0.07) specialColor="red"
  else if(special>0.055) specialColor="orange"

  document.getElementById("specialProb").innerHTML=
    `<span class="${specialColor}">${(special*100).toFixed(2)}%</span>`

  let intervalText="目前間隔: "
  if(lastSpecialIndex!=-1){
    intervalText+=history.length-1-lastSpecialIndex
  }else{
    intervalText+="N/A"
  }
  intervalText+="<br>歷史: "+specialIntervals.join(" → ")
  document.getElementById("intervalHistory").innerHTML=intervalText

  let accuracy= wins+losses>0 ? (wins/(wins+losses)*100).toFixed(2):0

  document.getElementById("tradePanel").innerHTML=
    `資金: ${bankroll.toFixed(2)}<br>
     回撤: ${((peak-bankroll)/peak*100).toFixed(2)}%<br>
     連勝: ${consecutiveWin} / 連輸: ${consecutiveLose}<br>
     鎖定局數: ${lockRounds}`

  document.getElementById("accuracy").innerText=`準確率: ${accuracy}%`

  let trendDiv=document.getElementById("trend")
  trendDiv.innerHTML=""
  trend.forEach(r=>{
    let box=document.createElement("div")
    box.classList.add("trendItem")
    if(r=="win") box.classList.add("win")
    else if(r=="lose") box.classList.add("lose")
    else box.classList.add("skip")
    trendDiv.appendChild(box)
  })
}

function runSimulation(){

  let rounds=parseInt(document.getElementById("simRounds").value)
  let simBank=bankroll
  let simPeak=simBank
  let simWins=0
  let simLoss=0

  for(let i=0;i<rounds;i++){
    let d=[rand(),rand(),rand()]
    let sum=d[0]+d[1]+d[2]
    let size=sum>=11?"big":"small"
    let bet=simBank*0.02
    if(Math.random()>0.5){
      simBank+=bet
      simWins++
    }else{
      simBank-=bet
      simLoss++
    }
    if(simBank>simPeak) simPeak=simBank
  }

  document.getElementById("simResult").innerHTML=
    `回測資金: ${simBank.toFixed(2)}<br>
     勝率: ${(simWins/(simWins+simLoss)*100).toFixed(2)}%<br>
     最大回撤: ${((simPeak-simBank)/simPeak*100).toFixed(2)}%`
}

function rand(){return Math.floor(Math.random()*6)+1}

</script>
</body>
</html>