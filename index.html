<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ä¹éª°é æ¸¬ç³»çµ± v4.2 ç©©å®šå„ªåŒ–ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial;text-align:center;}
.container{max-width:1300px;margin:auto;padding:20px;}
.card{background:#1e293b;padding:20px;margin-top:20px;border-radius:12px;}
.dice-btn{width:50px;height:50px;margin:5px;font-size:18px;border-radius:8px;border:none;cursor:pointer;background:#334155;color:white;}
.prob{font-size:26px;font-weight:bold;}
.flex{display:flex;gap:20px;}
.side{width:320px;}
.trend-box{display:flex;flex-wrap:wrap;gap:3px;margin-top:10px;}
.win{width:12px;height:12px;background:#22c55e;}
.lose{width:12px;height:12px;background:#ef4444;}
.stat{font-size:13px;color:#94a3b8;margin-top:5px;}
.toggle-btn{margin:5px;padding:4px 8px;background:#334155;border:none;color:white;border-radius:6px;cursor:pointer;}
.active{background:#22c55e;}
</style>
</head>
<body>

<div class="container">
<h1>ä¹éª°é æ¸¬ç³»çµ± v4.2</h1>

<div class="card">
<h3>é¸æ“‡ä¸‰é¡†éª°å­</h3>
<div id="diceButtons"></div>
<div>å·²é¸ï¼š<span id="selectedDice"></span></div>
<button onclick="submitRound()">æ–°å¢</button>
<button onclick="deleteLast()">åˆªé™¤ä¸Šä¸€å±€</button>
</div>

<div class="flex">

<div style="flex:1">

<div class="card">
<h3>ç‰¹æ®Šæ©Ÿç‡ï¼ˆè±¹å­ + 17ï¼‰</h3>
<div id="specialProb" class="prob">4.17%</div>
<div id="gapInfo" class="stat"></div>
<div id="gapHistory" class="stat"></div>
</div>

<div class="card">
<h3>å¤§å°é æ¸¬</h3>
<div id="bigSmall" class="prob"></div>
<div class="stat">
ä¿å®ˆæº–ç¢ºç‡ï¼š<span id="accuracyCons">0%</span> |
é«˜æ³¢å‹•æº–ç¢ºç‡ï¼š<span id="accuracyAggr">0%</span>
</div>
</div>

</div>

<div class="side card">
<h3>å‘½ä¸­è¶¨å‹¢</h3>

<button class="toggle-btn active" onclick="setTrend(20)" id="btn20">20</button>
<button class="toggle-btn" onclick="setTrend(40)" id="btn40">40</button>

<h4>ğŸ›¡ ä¿å®ˆ</h4>
<div id="trendCons" class="trend-box"></div>
<div id="statsCons" class="stat"></div>

<h4>ğŸ”¥ é«˜æ³¢å‹•</h4>
<div id="trendAggr" class="trend-box"></div>
<div id="statsAggr" class="stat"></div>

</div>

</div>

<div class="card">
<h3>æœ€è¿‘30å±€</h3>
<div id="history"></div>
</div>

<div class="card">
<h3>ç‰¹æ®Šæ©Ÿç‡èµ°å‹¢</h3>
<div id="chart" style="height:300px;"></div>
</div>

</div>

<script>

const BASE_SPECIAL=0.0417;
let rounds=[],selected=[];
let predictionsCons=[],predictionsAggr=[];
let specialProbs=[],specialIntervals=[];
let lastSpecialIndex=null;
let trendLength=20;
let chart=echarts.init(document.getElementById('chart'));

/* å»ºç«‹éª°å­ */
(function(){
  const c=document.getElementById("diceButtons");
  for(let i=1;i<=6;i++){
    const b=document.createElement("button");
    b.innerText=i;
    b.className="dice-btn";
    b.onclick=()=>{ if(selected.length<3){ selected.push(i); updateSel(); } };
    c.appendChild(b);
  }
})();

function updateSel(){
  document.getElementById("selectedDice").innerText=selected.join(",");
}

/* æ–°å¢ */
function submitRound(){
  if(selected.length!==3)return;

  const [d1,d2,d3]=selected;
  const sum=d1+d2+d3;
  const isBao=(d1===d2&&d2===d3);
  const is17=(sum===17);
  const isSpecial=isBao||is17;
  const size=sum>=11?"å¤§":"å°";

  if(isSpecial){
    if(lastSpecialIndex!==null)
      specialIntervals.push(rounds.length-lastSpecialIndex);
    lastSpecialIndex=rounds.length;
  }

  rounds.push({d1,d2,d3,sum,isSpecial,size});
  selected=[];
  updateSel();
  rebuildAll();
}

function deleteLast(){
  if(!rounds.length)return;
  rounds.pop();
  rebuildAll();
}

/* ===== æ ¸å¿ƒé‡å»º ===== */

function rebuildAll(){
  predictionsCons=[];
  predictionsAggr=[];
  specialProbs=[];
  lastSpecialIndex=null;

  for(let i=0;i<rounds.length;i++){
    if(rounds[i].isSpecial){
      if(lastSpecialIndex!==null)
        specialIntervals.push(i-lastSpecialIndex);
      lastSpecialIndex=i;
    }
  }

  for(let i=1;i<=rounds.length;i++){
    calculateSpecial(i);
    if(i>=2) calculateBigSmall(i);
  }

  updateDisplay();
}

/* ===== ç‰¹æ®Šæ©Ÿç‡ ===== */

function calculateSpecial(index){
  const gap = lastSpecialIndex===null ? index :
              index-1-lastSpecialIndex;

  let weight=1;

  [1,3,5,10,14,16,18].forEach(p=>{
    weight+=Math.exp(-((gap-p)**2)/7)*0.75;
  });

  if(gap>20) weight+=0.45+(gap-20)*0.035;
  if(gap<3) weight*=0.75;

  let prob=BASE_SPECIAL*weight;
  prob=Math.min(Math.max(prob,0.025),0.16);

  specialProbs.push((prob*100).toFixed(2));

  document.getElementById("specialProb").innerText=(prob*100).toFixed(2)+"%";
  document.getElementById("gapInfo").innerText="ç›®å‰é–“éš”ï¼š"+gap;
  document.getElementById("gapHistory").innerText=
    "æ­·å²é–“éš”ï¼š"+specialIntervals.slice(-10).reverse().join(" â†’ ");
}

/* ===== æ”¹è‰¯å¤§å°é æ¸¬ ===== */

function calculateBigSmall(index){

  const history=rounds.slice(0,index-1);
  const seq=history.map(r=>r.size==="å¤§"?1:0);

  const recent=seq.slice(-6);
  const bigCount=recent.reduce((a,b)=>a+b,0);
  const smallCount=recent.length-bigCount;

  const momentum=(bigCount-smallCount)/recent.length;

  let flips=0;
  for(let i=1;i<recent.length;i++)
    if(recent[i]!==recent[i-1])flips++;

  const flipRate=recent.length>1?flips/(recent.length-1):0;

  /* ä¿å®ˆ */
  let consProb=0.5+momentum*0.25;
  consProb=Math.max(0.15,Math.min(0.85,consProb));
  const cons = consProb>=0.5?"å¤§":"å°";

  predictionsCons.push(cons);

  /* é«˜æ³¢å‹• */
  let aggrProb;

  if(flipRate>0.55){
    aggrProb=0.5-momentum*0.35; // éœ‡ç›ªæå‰åè½‰
  }else{
    aggrProb=0.5+momentum*0.45; // å–®é‚ŠåŠ é€Ÿ
  }

  aggrProb=Math.max(0.1,Math.min(0.9,aggrProb));
  const aggr = aggrProb>=0.5?"å¤§":"å°";

  predictionsAggr.push(aggr);
}

/* ===== æ›´æ–°ç•«é¢ ===== */

function updateDisplay(){

  let resultsC=[],resultsA=[];
  for(let i=1;i<rounds.length;i++){
    resultsC.push(predictionsCons[i-1]===rounds[i].size);
    resultsA.push(predictionsAggr[i-1]===rounds[i].size);
  }

  document.getElementById("accuracyCons").innerText=
    calcRate(resultsC).toFixed(1)+"%";
  document.getElementById("accuracyAggr").innerText=
    calcRate(resultsA).toFixed(1)+"%";

  if(rounds.length){
    document.getElementById("bigSmall").innerHTML=
      `ğŸ›¡ ä¿å®ˆé æ¸¬ï¼š${predictionsCons[predictionsCons.length-1]}<br>
       ğŸ”¥ é«˜æ³¢å‹•é æ¸¬ï¼š${predictionsAggr[predictionsAggr.length-1]}`;
  }

  drawTrend("trendCons",resultsC);
  drawTrend("trendAggr",resultsA);

  document.getElementById("statsCons").innerText=
    `20å±€:${calcRecent(resultsC,20).toFixed(1)}% | 50å±€:${calcRecent(resultsC,50).toFixed(1)}%`;

  document.getElementById("statsAggr").innerText=
    `20å±€:${calcRecent(resultsA,20).toFixed(1)}% | 50å±€:${calcRecent(resultsA,50).toFixed(1)}%`;

  document.getElementById("history").innerText=
    rounds.slice(-30)
    .map(r=>`${r.d1}${r.d2}${r.d3}${r.isSpecial?'â˜…':''}`)
    .join(" , ");

  drawChart();
}

/* å·¥å…· */

function drawTrend(id,arr){
  const div=document.getElementById(id);
  div.innerHTML="";
  arr.slice(-trendLength).forEach(w=>{
    const d=document.createElement("div");
    d.className=w?"win":"lose";
    div.appendChild(d);
  });
}

function calcRate(arr){
  if(!arr.length)return 0;
  return arr.filter(x=>x).length/arr.length*100;
}

function calcRecent(arr,n){
  const slice=arr.slice(-n);
  if(!slice.length)return 0;
  return slice.filter(x=>x).length/slice.length*100;
}

function setTrend(n){
  trendLength=n;
  document.getElementById("btn20").classList.remove("active");
  document.getElementById("btn40").classList.remove("active");
  document.getElementById("btn"+n).classList.add("active");
  updateDisplay();
}

function drawChart(){
  chart.setOption({
    xAxis:{type:'category',data:specialProbs.map((_,i)=>i+1)},
    yAxis:{type:'value'},
    series:[{data:specialProbs,type:'line',smooth:true}]
  });
}

</script>
</body>
</html>
