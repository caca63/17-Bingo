<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ä¸‰éª°å°ˆæ¥­é æ¸¬å™¨ 3.5 é›™æ¨¡å‹å®Œæ•´ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial;text-align:center;}
.container{max-width:1300px;margin:auto;padding:20px;}
.card{background:#1e293b;padding:20px;margin-top:20px;border-radius:12px;}
.dice-btn{width:50px;height:50px;margin:5px;font-size:18px;border-radius:8px;border:none;cursor:pointer;background:#334155;color:white;}
.prob{font-size:36px;font-weight:bold;}
.cold{color:#38bdf8;}
.warm{color:#facc15;}
.hot{color:#f87171;}
.big{color:#f87171;font-size:22px;}
.small{color:#38bdf8;font-size:22px;}
.flex{display:flex;gap:20px;}
.side{width:300px;}
.trend-box{display:flex;flex-wrap:wrap;gap:3px;margin-top:10px;}
.win{width:12px;height:12px;background:#22c55e;}
.lose{width:12px;height:12px;background:#ef4444;}
.stat{font-size:13px;color:#94a3b8;}
.toggle-btn{margin:5px;padding:4px 8px;background:#334155;border:none;color:white;border-radius:6px;cursor:pointer;}
.active{background:#22c55e;}
</style>
</head>
<body>

<div class="container">
<h1>ä¸‰éª°å°ˆæ¥­é æ¸¬å™¨ 3.5 é›™æ¨¡å‹å®Œæ•´ç‰ˆ</h1>

<div class="card">
<h3>é¸æ“‡ä¸‰é¡†éª°å­ / æ‰‹å‹•è¼¸å…¥</h3>
<div id="diceButtons"></div>
<div>å·²é¸ï¼š<span id="selectedDice"></span></div>
<input id="manualInput" placeholder="ä¾‹:645 æˆ– 555â˜…">
<button onclick="submitRound()">ç¢ºèªæ–°å¢</button>
</div>

<div class="flex">
<div style="flex:1">

<div class="card">
<h3>ç‰¹æ®Šæ©Ÿç‡ï¼ˆè±¹å­+17ï¼‰</h3>
<div id="specialProb" class="prob cold">4.17%</div>
<div id="gapInfo" class="stat"></div>
<div id="gapHistory" class="stat"></div>
</div>

<div class="card">
<h3>å¤§å°é æ¸¬</h3>
<div id="bigSmall"></div>
<div class="stat">æº–ç¢ºç‡ï¼š<span id="accuracy">0%</span></div>
</div>

<div class="card">
<h3>è³‡é‡‘ç®¡ç†</h3>
<div id="bankrollInfo" class="stat"></div>
</div>

</div>

<div class="side card">
<h3>å‘½ä¸­è¶¨å‹¢</h3>
<button class="toggle-btn active" onclick="setTrend(20)" id="btn20">20</button>
<button class="toggle-btn" onclick="setTrend(40)" id="btn40">40</button>
<div id="trendBoxes" class="trend-box"></div>
<div id="streakInfo" class="stat"></div>
</div>
</div>

<div class="card">
<h3>æœ€è¿‘30å±€</h3>
<div id="history"></div>
</div>

<div class="card">
<h3>ç‰¹æ®Šæ©Ÿç‡èµ°å‹¢</h3>
<div id="chart" style="height:300px;"></div>
</div>
</div>

<script>
const BASE_SPECIAL=0.0417;
const BASE_BIG=0.5;

let rounds=[];
let selected=[];
let specialProbs=[];
let specialIntervals=[];
let lastSpecialIndex=null;
let predictions=[];
let validCount=0;
let correctCount=0;
let trendLength=20;

let bankroll=10000;
let baseUnit=100;
let peak=10000;

let consWins=0, consLoss=0, consStreak=0;
let aggrWins=0, aggrLoss=0, aggrStreak=0;
let lastCons=null, lastAggr=null;

let chart=echarts.init(document.getElementById('chart'));

/* ===== å»ºç«‹éª°å­æŒ‰éˆ• ===== */
function createButtons(){
  const c=document.getElementById("diceButtons");
  for(let i=1;i<=6;i++){
    const b=document.createElement("button");
    b.innerText=i;
    b.className="dice-btn";
    b.onclick=()=>selectDice(i);
    c.appendChild(b);
  }
}
createButtons();

function selectDice(n){
  if(selected.length<3){
    selected.push(n);
    document.getElementById("selectedDice").innerText=selected.join(",");
  }
}

/* ===== æäº¤å±€æ•¸ ===== */
function submitRound(){
  let input=document.getElementById("manualInput").value.trim();
  let d1,d2,d3,isLeopard=false;
  if(input){
    isLeopard=input.includes("â˜…");
    input=input.replace("â˜…","");
    if(input.length!==3){alert("æ ¼å¼éŒ¯èª¤");return;}
    d1=parseInt(input[0]); d2=parseInt(input[1]); d3=parseInt(input[2]);
    selected=[d1,d2,d3];
  }
  if(selected.length!==3){alert("è«‹é¸ä¸‰é¡†");return;}

  const [x1,x2,x3]=selected;
  const sum=x1+x2+x3;
  const isBao=(x1===x2 && x2===x3);
  const is17=(sum===17);
  const isSpecial=isBao || is17;

  const size=isBao?null:(sum>=11?"å¤§":"å°");

  if(predictions.length>0 && size!==null){
    validCount++;
    const win=predictions[predictions.length-1]===size;
    if(win) correctCount++;
    updateBank(win);
  }

  if(isSpecial){
    if(lastSpecialIndex!==null){
      specialIntervals.push(rounds.length-lastSpecialIndex);
    }
    lastSpecialIndex=rounds.length;
  }

  rounds.push({d1:x1,d2:x2,d3:x3,sum,isSpecial,size});
  selected=[];
  document.getElementById("selectedDice").innerText="";
  document.getElementById("manualInput").value="";
  calculate();
}

/* ===== ç‰¹æ®Šçµ„åˆåç§» ===== */
function getComboBias(){
  const last3=rounds.slice(-3);
  if(last3.length<3) return 0;
  let triple=0,pair=0;
  last3.forEach(r=>{
    const map={};
    [r.d1,r.d2,r.d3].forEach(n=>map[n]=(map[n]||0)+1);
    const v=Object.values(map);
    if(v.includes(3)) triple++;
    else if(v.includes(2)) pair++;
  });
  if(triple===3) return -0.06;
  if(triple===2 && pair===1) return -0.05;
  if(triple===1 && pair===2) return -0.04;
  return 0;
}

/* ===== ç‰¹æ®Šæ©Ÿç‡è¨ˆç®—ï¼ˆå«é–“éš”èˆ‡æ­·å²ï¼‰ ===== */
function calculateSpecial(){
  let gap= lastSpecialIndex===null?rounds.length:rounds.length-1-lastSpecialIndex;
  let weight=1;
  [1,3,5,10,14,16,18].forEach(p=>{
    weight+=Math.exp(-((gap-p)**2)/7)*0.7;
  });
  if(gap>20) weight+=0.4+(gap-20)*0.03;
  if(gap<3) weight*=0.75;

  const last3=rounds.slice(-3);
  if(last3.length===3){
    const types=last3.map(r=>{
      const map={};
      [r.d1,r.d2,r.d3].forEach(n=>map[n]=(map[n]||0)+1);
      const v=Object.values(map);
      if(v.includes(3)) return 3;
      if(v.includes(2)) return 2;
      return 1;
    });
    const triple=types.filter(t=>t===3).length;
    const dbl=types.filter(t=>t===2).length;
    if(triple===3) weight+=1.05;
    else if(triple===2 && dbl===1) weight+=0.85;
    else if(triple===2 && dbl===2) weight+=0.6;
    else if(triple===1 && dbl===3) weight+=0.35;
  }

  let prob=BASE_SPECIAL*weight;
  if(prob>0.16) prob=0.16;
  if(prob<0.025) prob=0.025;

  specialProbs.push((prob*100).toFixed(2));
  document.getElementById("specialProb").innerText=(prob*100).toFixed(2)+"%";
  document.getElementById("gapInfo").innerText="ç›®å‰é–“éš”ï¼š"+gap;
  document.getElementById("gapHistory").innerText="æ­·å²é–“éš”ï¼š"+specialIntervals.slice(-10).reverse().join(" â†’ ");

  drawChart();
}

/* ===== å¤§å°é æ¸¬ï¼ˆä¿å®ˆ vs é€²æ”»ï¼‰ ===== */
function calculateBigSmall(){
  let score=0;
  const last8=rounds.slice(-8).filter(r=>r.size!==null);
  if(last8.length>=5){
    const seq=last8.map(r=>r.size==="å¤§"?1:0);
    const last=seq[seq.length-1];
    let run=1,maxRun=1,flip=0;
    for(let i=1;i<seq.length;i++){
      if(seq[i]===seq[i-1]){run++;maxRun=Math.max(maxRun,run);}else run=1;
      if(seq[i]!==seq[i-1]) flip++;
    }
    if(maxRun>=4) score+= last?0.12:-0.12;
    if(flip>=5) score+= last?-0.10:0.10;
  }

  score+=getComboBias();
  score+=(Math.random()-0.5)*0.05;

  let bigProbCons=50, bigProbAggr=50;

  // ä¿å®ˆæ¨¡å‹
  const last30=rounds.slice(-30).filter(r=>r.size!==null);
  const bigCount=last30.filter(r=>r.size==="å¤§").length;
  const smallCount=last30.length-bigCount;

  bigProbCons=50+((bigCount-smallCount)/30*10);
  if(bigProbCons>55) bigProbCons=55;
  if(bigProbCons<45) bigProbCons=45;

  // é€²æ”»æ¨¡å‹
  bigProbAggr=50+((bigCount-smallCount)/30*20);
  if(bigProbAggr>58) bigProbAggr=58;
  if(bigProbAggr<42) bigProbAggr=42;

  const smallProbCons=100-bigProbCons;
  const smallProbAggr=100-bigProbAggr;

  // å‘½ä¸­è¶¨å‹¢çµ±è¨ˆ
  if(lastCons!==null){
    const actual=rounds[rounds.length-1].size==="å¤§";
    if(lastCons===actual){consWins++;consStreak++;}else{consLoss++;consStreak=0;}
  }
  if(lastAggr!==null){
    const actual=rounds[rounds.length-1].size==="å¤§";
    if(lastAggr===actual){aggrWins++;aggrStreak++;}else{aggrLoss++;aggrStreak=0;}
  }

  lastCons=bigProbCons>=50;
  lastAggr=bigProbAggr>=50;

  predictions.push(bigProbCons>=50?"å¤§":"å°");

  document.getElementById("bigSmall").innerHTML=`
    ğŸ›¡ ä¿å®ˆ<br>
    å¤§ ${bigProbCons.toFixed(1)}% | å° ${smallProbCons.toFixed(1)}%<br><br>
    ğŸ”¥ é«˜æ³¢å‹•<br>
    å¤§ ${bigProbAggr.toFixed(1)}% | å° ${smallProbAggr.toFixed(1)}%<brbr>
  `;

  const acc=validCount>0?(correctCount/validCount*100).toFixed(1):0;
  document.getElementById("accuracy").innerText=acc+"%";

  updateTrendBoxes();
}

/* ===== æ›´æ–°è³‡é‡‘ç®¡ç† ===== */
function updateBank(win){
  let bet=Math.floor(bankroll*0.02/baseUnit)*baseUnit;
  if(bet<baseUnit) bet=baseUnit;
  if(win) bankroll+=bet; else bankroll-=bet;
  if(bankroll>peak) peak=bankroll;
  let drawdown=((peak-bankroll)/peak*100).toFixed(2);
  document.getElementById("bankrollInfo").innerText=
    `è³‡é‡‘ï¼š${bankroll} | æœ¬æ³¨ï¼š${bet} | æœ€å¤§å›æ’¤ï¼š${drawdown}%`;
}

/* ===== å‘½ä¸­è¶¨å‹¢é¡¯ç¤º ===== */
function setTrend(n){
  trendLength=n;
  document.getElementById("btn20").classList.remove("active");
  document.getElementById("btn40").classList.remove("active");
  document.getElementById("btn"+n).classList.add("active");
  updateTrendBoxes();
}

function updateTrendBoxes(){
  const container=document.getElementById("trendBoxes");
  container.innerHTML="";
  let results=[];
  for(let i=1;i<rounds.length;i++){
    if(rounds[i].size!==null){
      results.push(predictions[i-1]===rounds[i].size);
    }
  }
  const last=results.slice(-trendLength);
  last.forEach(win=>{
    const box=document.createElement("div");
    box.className=win?"win":"lose";
    container.appendChild(box);
  });
  if(last.length>0){
    let current=last[last.length-1],streak=1;
    for(let i=last.length-2;i>=0;i--){
      if(last[i]===current) streak++;
      else break;
    }
    document.getElementById("streakInfo").innerText=
      (current?"é€£è´ ":"é€£è¼¸ ")+streak+" æœŸ";
  }
}

/* ===== æ›´æ–°æ­·å²èˆ‡è¨ˆç®— ===== */
function calculate(){
  calculateSpecial();
  calculateBigSmall();
  document.getElementById("history").innerText=
    rounds.slice(-30).map(r=>`${r.d1}${r.d2}${r.d3}${r.isSpecial?'â˜…':''}`).join(" , ");
}

/* ===== ç¹ªè£½ç‰¹æ®Šæ©Ÿç‡èµ°å‹¢ ===== */
function drawChart(){
  chart.setOption({
    xAxis:{type:'category',data:specialProbs.map((_,i)=>i+1)},
    yAxis:{type:'value'},
    series:[{data:specialProbs,type:'line',smooth:true}]
  });
}
</script>
</body>
</html>
