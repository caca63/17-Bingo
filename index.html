<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>三骰專業預測器 3.0</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial;text-align:center;}
.container{max-width:1300px;margin:auto;padding:20px;}
.card{background:#1e293b;padding:20px;margin-top:20px;border-radius:12px;}
.dice-btn{width:50px;height:50px;margin:5px;font-size:18px;border-radius:8px;border:none;cursor:pointer;background:#334155;color:white;}
.prob{font-size:36px;font-weight:bold;}
.cold{color:#38bdf8;}
.warm{color:#facc15;}
.hot{color:#f87171;}
.big{color:#f87171;font-size:22px;}
.small{color:#38bdf8;font-size:22px;}
.flex{display:flex;gap:20px;}
.side{width:260px;}
.trend-box{display:flex;flex-wrap:wrap;gap:3px;margin-top:10px;}
.win{width:12px;height:12px;background:#22c55e;}
.lose{width:12px;height:12px;background:#ef4444;}
.stat{font-size:13px;color:#94a3b8;}
</style>
</head>
<body>

<div class="container">

<h1>三骰專業預測器 3.0</h1>

<div class="card">
<h3>選擇三顆骰子</h3>
<div id="diceButtons"></div>
<div>已選：<span id="selectedDice"></span></div>
<button onclick="submitRound()" style="margin-top:10px;padding:8px 15px;">確認新增</button>
</div>

<div class="flex">

<div style="flex:1">

<div class="card">
<h3>特殊機率（豹子+17）</h3>
<div id="specialProb" class="prob cold">4.17%</div>
<div id="gapInfo"></div>
<div id="gapHistory" class="stat"></div>
</div>

<div class="card">
<h3>大小預測</h3>
<div id="bigSmall"></div>
<div class="stat">準確率：<span id="accuracy">0%</span></div>
</div>

<div class="card">
<h3>資金管理</h3>
<div id="bankrollInfo" class="stat"></div>
</div>

</div>

<div class="side card">
<h3>命中趨勢(20)</h3>
<div id="trendBoxes" class="trend-box"></div>
<div id="streakInfo" class="stat"></div>
</div>

</div>

<div class="card">
<h3>最近30局</h3>
<div id="history"></div>
</div>

<div class="card">
<h3>特殊機率走勢</h3>
<div id="chart" style="height:300px;"></div>
</div>

</div>

<script>
const BASE_SPECIAL=0.0417;
const BASE_BIG=0.486;

let rounds=[];
let selected=[];
let specialProbs=[];
let predictions=[];
let specialIntervals=[];
let lastSpecialIndex=null;
let correctCount=0;

// 風控系統
let bankroll=10000;
let baseBet=100;
let currentBet=100;
let peak=10000;
let maxDrawdown=0;

function createButtons(){
  const c=document.getElementById("diceButtons");
  for(let i=1;i<=6;i++){
    const b=document.createElement("button");
    b.innerText=i;
    b.className="dice-btn";
    b.onclick=()=>selectDice(i);
    c.appendChild(b);
  }
}
createButtons();

function selectDice(n){
  if(selected.length<3){
    selected.push(n);
    document.getElementById("selectedDice").innerText=selected.join(",");
  }
}

function submitRound(){
  if(selected.length!==3){alert("請選三顆");return;}

  const [d1,d2,d3]=selected;
  const sum=d1+d2+d3;
  const isBao=(d1===d2&&d2===d3);
  const is17=(sum===17);
  const isSpecial=isBao||is17;
  const size=sum>=11?"大":"小";

  // 對齊預測
  if(predictions.length>0){
    const lastPred=predictions[predictions.length-1];
    const win=lastPred===size;
    if(win) correctCount++;
    updateBet(win);
  }

  if(isSpecial){
    if(lastSpecialIndex!==null){
      specialIntervals.push(rounds.length-lastSpecialIndex);
    }
    lastSpecialIndex=rounds.length;
  }

  rounds.push({d1,d2,d3,sum,isSpecial,size});
  selected=[];
  document.getElementById("selectedDice").innerText="";
  calculate();
}

function getGap(){
  if(lastSpecialIndex===null) return rounds.length;
  return rounds.length-1-lastSpecialIndex;
}

function densityWeight(){
  const last=rounds.slice(-3);
  if(last.length===0) return 1;
  const freq=[0,0,0,0,0,0];
  last.forEach(r=>{
    freq[r.d1-1]++;
    freq[r.d2-1]++;
    freq[r.d3-1]++;
  });
  const mean=freq.reduce((a,b)=>a+b)/6;
  const variance=freq.reduce((a,b)=>a+(b-mean)**2,0)/6;
  const std=Math.sqrt(variance);
  return 1+std*0.12;
}

function structureWeight(){
  if(rounds.length===0) return 1;
  const last=rounds[rounds.length-1];
  const arr=[last.d1,last.d2,last.d3];
  const set=new Set(arr);
  let w=1;
  if(set.size===2){
    arr.sort((a,b)=>a-b);
    if(Math.abs(arr[2]-arr[0])>=3) w+=0.2;
  }
  if(set.size===1) w+=0.35;
  return w;
}

function calculateSpecial(){
  const gap=getGap();
  let intervalW=1;
  [1,3,5,10,14,16,18].forEach(p=>{
    intervalW+=Math.exp(-((gap-p)**2)/8)*0.6;
  });

  let prob=BASE_SPECIAL*intervalW*densityWeight()*structureWeight();
  if(prob>0.12) prob=0.12;
  if(prob<0.025) prob=0.025;

  specialProbs.push((prob*100).toFixed(2));

  let color="cold";
  if(prob>0.08) color="hot";
  else if(prob>0.05) color="warm";

  const el=document.getElementById("specialProb");
  el.className="prob "+color;
  el.innerText=(prob*100).toFixed(2)+"%";

  document.getElementById("gapInfo").innerText="目前間隔："+gap;
  document.getElementById("gapHistory").innerText=
    "歷史間隔："+specialIntervals.slice(-10).reverse().join(" → ");
}

function calculateBigSmall(){
  let score=0;

  if(rounds.length>1){
    const prev=rounds[rounds.length-1].size;
    if(prev==="大") score-=0.12;
    if(prev==="小") score+=0.12;
  }

  const last6=rounds.slice(-6).map(r=>r.size).join("");
  if(last6.includes("大小大小")) score+=0.2;
  if(last6.includes("大大小")) score-=0.15;

  let bigProb=BASE_BIG+score;
  let smallProb=BASE_BIG-score;

  const prediction=bigProb>smallProb?"大":"小";
  predictions.push(prediction);

  document.getElementById("bigSmall").innerHTML=
    `<div class="${prediction==="大"?"big":"small"}">
     預測：${prediction}
     </div>
     <div>大 ${(bigProb*100).toFixed(1)}% | 小 ${(smallProb*100).toFixed(1)}%</div>`;

  const total=predictions.length-1;
  const acc=total>0?(correctCount/total*100).toFixed(1):0;
  document.getElementById("accuracy").innerText=acc+"%";

  updateTrendBoxes();
}

function updateTrendBoxes(){
  const container=document.getElementById("trendBoxes");
  container.innerHTML="";
  let results=[];

  for(let i=1;i<rounds.length;i++){
    results.push(predictions[i-1]===rounds[i].size);
  }

  const last20=results.slice(-20);
  last20.forEach(win=>{
    const box=document.createElement("div");
    box.className=win?"win":"lose";
    container.appendChild(box);
  });

  if(last20.length>0){
    let current=last20[last20.length-1];
    let streak=1;
    for(let i=last20.length-2;i>=0;i--){
      if(last20[i]===current) streak++;
      else break;
    }
    document.getElementById("streakInfo").innerText=
      (current?"連贏 ":"連輸 ")+streak+" 期";
  }
}

function updateBet(win){
  if(win){
    bankroll+=currentBet;
    currentBet=baseBet;
  }else{
    bankroll-=currentBet;
    currentBet=Math.min(baseBet*1.5, bankroll*0.05);
  }

  if(bankroll>peak) peak=bankroll;
  const drawdown=peak-bankroll;
  if(drawdown>maxDrawdown) maxDrawdown=drawdown;

  document.getElementById("bankrollInfo").innerText=
    "資金："+bankroll+
    " | 本注："+Math.round(currentBet)+
    " | 最大回撤："+maxDrawdown;
}

function calculate(){
  calculateSpecial();
  calculateBigSmall();

  document.getElementById("history").innerText=
    rounds.slice(-30)
    .map(r=>`${r.d1}${r.d2}${r.d3}${r.isSpecial?'★':''}`)
    .join(" , ");

  drawChart();
}

function drawChart(){
  const chart=echarts.init(document.getElementById('chart'));
  chart.setOption({
    xAxis:{type:'category',data:specialProbs.map((_,i)=>i+1)},
    yAxis:{type:'value'},
    series:[{data:specialProbs,type:'line',smooth:true}]
  });
}
</script>

</body>
</html>