<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ä¹éª°é æ¸¬ç³»çµ± v4.3 ä¿®æ­£ç‰ˆ</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial;text-align:center;}
.container{max-width:1300px;margin:auto;padding:20px;}
.card{background:#1e293b;padding:20px;margin-top:20px;border-radius:12px;}
.dice-btn{width:50px;height:50px;margin:5px;font-size:18px;border-radius:8px;border:none;cursor:pointer;background:#334155;color:white;}
.prob{font-size:36px;font-weight:bold;}
.cold{color:#38bdf8;}
.warm{color:#facc15;}
.hot{color:#f87171;}
.big{color:#f87171;font-size:22px;}
.small{color:#38bdf8;font-size:22px;}
.flex{display:flex;gap:20px;}
.side{width:300px;}
.trend-box{display:flex;flex-wrap:wrap;gap:3px;margin-top:10px;}
.win{width:12px;height:12px;background:#22c55e;}
.lose{width:12px;height:12px;background:#ef4444;}
.stat{font-size:13px;color:#94a3b8;margin-top:3px;}
.toggle-btn{margin:5px;padding:4px 8px;background:#334155;border:none;color:white;border-radius:6px;cursor:pointer;}
.active{background:#22c55e;}
</style>
</head>
<body>

<div class="container">

<h1>ä¹éª°é æ¸¬ç³»çµ± v4.3</h1>

<div class="card">
<h3>é¸æ“‡ä¸‰é¡†éª°å­</h3>
<div id="diceButtons"></div>
<div>å·²é¸ï¼š<span id="selectedDice"></span></div>
<button onclick="submitRound()" style="margin-top:10px;padding:8px 15px;">ç¢ºèªæ–°å¢</button>
<button onclick="deleteLast()" style="margin-top:10px;padding:8px 15px;">åˆªé™¤ä¸Šä¸€å±€</button>
</div>

<div class="flex">

<div style="flex:1">

<div class="card">
<h3>ç‰¹æ®Šæ©Ÿç‡ï¼ˆè±¹å­+17ï¼‰</h3>
<div id="specialProb" class="prob cold">4.17%</div>
<div id="gapInfo"></div>
<div id="gapHistory" class="stat"></div>
</div>

<div class="card">
<h3>å¤§å°é æ¸¬</h3>
<div id="bigSmall"></div>
<div class="stat">ä¿å®ˆæº–ç¢ºç‡ï¼š<span id="accuracyCons">0%</span> | é«˜æ³¢å‹•æº–ç¢ºç‡ï¼š<span id="accuracyAggr">0%</span></div>
</div>

<div class="card">
<h3>è³‡é‡‘ç®¡ç†</h3>
<div id="bankrollInfo" class="stat"></div>
</div>

</div>

<div class="side card">
<h3>å‘½ä¸­è¶¨å‹¢</h3>
<button class="toggle-btn active" onclick="setTrend(20)" id="btn20">20</button>
<button class="toggle-btn" onclick="setTrend(40)" id="btn40">40</button>

<h4>ğŸ›¡ ä¿å®ˆæ¨¡å¼</h4>
<div id="trendBoxesCons" class="trend-box"></div>
<div class="stat" id="streakCons"></div>
<div class="stat" id="winRateCons"></div>

<h4>ğŸ”¥ é«˜æ³¢å‹•æ¨¡å¼</h4>
<div id="trendBoxesAggr" class="trend-box" style="margin-top:5px;"></div>
<div class="stat" id="streakAggr"></div>
<div class="stat" id="winRateAggr"></div>
</div>

</div>

<div class="card">
<h3>æœ€è¿‘30å±€</h3>
<div id="history"></div>
</div>

<div class="card">
<h3>ç‰¹æ®Šæ©Ÿç‡èµ°å‹¢</h3>
<div id="chart" style="height:300px;"></div>
</div>

</div>

<script>
const BASE_SPECIAL=0.0417;

let rounds=[], selected=[], specialProbs=[], predictionsCons=[], predictionsAggr=[], specialIntervals=[], lastSpecialIndex=null;
let trendLength=20;

let bankroll=10000, baseUnit=100, peak=10000;
let correctCons=0, totalCons=0, correctAggr=0, totalAggr=0;

let chart=echarts.init(document.getElementById('chart'));

/* ===================
   å»ºç«‹éª°å­æŒ‰éˆ•
=================== */
function createButtons(){
  const c=document.getElementById("diceButtons");
  for(let i=1;i<=6;i++){
    const b=document.createElement("button");
    b.innerText=i;
    b.className="dice-btn";
    b.onclick=()=>selectDice(i);
    c.appendChild(b);
  }
}
createButtons();

function selectDice(n){
  if(selected.length<3){
    selected.push(n);
    document.getElementById("selectedDice").innerText=selected.join(",");
  }
}

/* ===================
   æ–°å¢/åˆªé™¤éª°å­çµæœ
=================== */
function submitRound(){
  if(selected.length!==3){alert("è«‹é¸ä¸‰é¡†");return;}
  const [d1,d2,d3]=selected;
  const sum=d1+d2+d3;
  const isBao=(d1===d2&&d2===d3);
  const is17=(sum===17);
  const isSpecial=isBao||is17;
  const size=sum>=11?"å¤§":"å°";

  if(predictionsCons.length>0){
    const winCons=predictionsCons[predictionsCons.length-1]===size;
    const winAggr=predictionsAggr[predictionsAggr.length-1]===size;
    if(winCons) correctCons++;
    if(winAggr) correctAggr++;
  }

  if(isSpecial){
    if(lastSpecialIndex!==null) specialIntervals.push(rounds.length-lastSpecialIndex);
    lastSpecialIndex=rounds.length;
  }

  rounds.push({d1,d2,d3,sum,isSpecial,size});
  selected=[]; document.getElementById("selectedDice").innerText="";
  calculate();
}

function deleteLast(){
  if(!rounds.length) return;
  rounds.pop();
  if(predictionsCons.length>0) predictionsCons.pop();
  if(predictionsAggr.length>0) predictionsAggr.pop();
  calculate();
}

/* ===================
   ç‰¹æ®Šæ©Ÿç‡
=================== */
function getGap(){ return lastSpecialIndex===null?rounds.length:rounds.length-1-lastSpecialIndex; }

function calculateSpecial(){
  const gap=getGap();
  let weight=1;
  [1,3,5,10,14,16,18].forEach(p=>{
    weight+=Math.exp(-((gap-p)**2)/7)*0.75;
  });
  if(gap>20) weight+=0.45+(gap-20)*0.035;
  if(gap<3) weight*=0.75;

  const last3=rounds.slice(-3);
  if(last3.length===3){
    const types=last3.map(r=>{
      const map={}; [r.d1,r.d2,r.d3].forEach(n=>map[n]=(map[n]||0)+1);
      const v=Object.values(map);
      if(v.includes(3)) return 3;
      if(v.includes(2)) return 2;
      return 1;
    });
    const triple=types.filter(t=>t===3).length;
    const dbl=types.filter(t=>t===2).length;
    if(triple===3) weight+=1.05;
    else if(triple===2&&dbl===1) weight+=0.85;
    else if(dbl===3) weight+=0.6;
    else if(dbl===2) weight+=0.35;
  }

  const recentSpecial=rounds.slice(-6).filter(r=>r.isSpecial).length;
  if(recentSpecial>=2) weight*=0.8;

  let prob=BASE_SPECIAL*weight;
  prob=Math.min(Math.max(prob,0.025),0.16);
  specialProbs.push((prob*100).toFixed(2));

  let color="cold";
  if(prob>0.115) color="hot";
  else if(prob>0.075) color="warm";

  const el=document.getElementById("specialProb");
  el.className="prob "+color;
  el.innerText=(prob*100).toFixed(2)+"%";

  document.getElementById("gapInfo").innerText="ç›®å‰é–“éš”ï¼š"+gap;
  document.getElementById("gapHistory").innerText="æ­·å²é–“éš”ï¼š"+specialIntervals.slice(-10).reverse().join(" â†’ ");

  drawChart();
}

/* ===================
   çŸ­é€±æœŸæª¢æ¸¬
=================== */
function analyzeCycle(seq){
  if(seq.length<4) return 0.5;
  let score=0.5;
  for(let p=2;p<=4;p++){
    let match=0,count=0;
    for(let i=0;i<=seq.length-p;i++){
      let slice=seq.slice(i,i+p).join(",");
      for(let j=i+p;j<=seq.length-p;j++){
        let comp=seq.slice(j,j+p).join(",");
        if(slice===comp) match++; count++;
      }
    }
    if(count>0) score=Math.max(score,0.5+match/count*0.5);
  }
  return score;
}

/* ===================
   å¤§å°é æ¸¬
=================== */
function calculateBigSmall(){
  const last10=rounds.slice(-10);
  const seq=last10.map(r=>r.size==="å¤§"?1:0);
  const fallback=seq.length?seq[seq.length-1]:0.5;

  // ä¿å®ˆ
  let trendWeight=0.6;
  let cycleScore=analyzeCycle(seq);
  let baseCons=seq.length?trendWeight*seq[seq.length-1]+(1-trendWeight)*cycleScore:0.5;
  baseCons=Math.min(Math.max(baseCons,0.1),0.9);
  predictionsCons.push(baseCons>=0.5?"å¤§":"å°");

  // é«˜æ³¢å‹•
  let flipCount=0; for(let i=1;i<seq.length;i++) if(seq[i]!==seq[i-1]) flipCount++;
  let flipRatio=seq.length>1?flipCount/(seq.length-1):0;
  let trendW=0.4*(1-flipRatio), cycleW=0.3, randomW=0.3+0.3*flipRatio;
  let baseAggr=seq.length?trendW*seq[seq.length-1]+cycleW*cycleScore+randomW*(Math.random()<0.5?0:1):0.5;
  baseAggr=Math.min(Math.max(baseAggr,0.1),0.9);
  predictionsAggr.push(baseAggr>=0.5?"å¤§":"å°");

  document.getElementById("bigSmall").innerHTML=
    `ğŸ›¡ ä¿å®ˆæ¨¡å¼: å¤§ ${(baseCons*100).toFixed(1)}% å° ${(100-baseCons*100).toFixed(1)}%<br>
     ğŸ”¥ é«˜æ³¢å‹•æ¨¡å¼: å¤§ ${(baseAggr*100).toFixed(1)}% å° ${(100-baseAggr*100).toFixed(1)}%`;
}

/* ===================
   æ›´æ–°å‘½ä¸­è¶¨å‹¢èˆ‡çµ±è¨ˆ
=================== */
function updateTrendBoxes(){
  const containerC=document.getElementById("trendBoxesCons");
  const containerA=document.getElementById("trendBoxesAggr");
  containerC.innerHTML=""; containerA.innerHTML="";

  let resultsC=[], resultsA=[];
  for(let i=1;i<rounds.length;i++){
    resultsC.push(predictionsCons[i-1]===rounds[i].size);
    resultsA.push(predictionsAggr[i-1]===rounds[i].size);
  }

  const lastC=resultsC.slice(-trendLength);
  const lastA=resultsA.slice(-trendLength);

  lastC.forEach(win=>{ const box=document.createElement("div"); box.className=win?"win":"lose"; containerC.appendChild(box); });
  lastA.forEach(win=>{ const box=document.createElement("div"); box.className=win?"win":"lose"; containerA.appendChild(box); });

  // streak
  if(lastC.length>0){ let current=lastC[lastC.length-1], streak=1;
    for(let i=lastC.length-2;i>=0;i--){if(lastC[i]===current) streak++; else break;}
    document.getElementById("streakCons").innerText=(current?"é€£è´ ":"é€£è¼¸ ")+streak+"æœŸ";
  }
  if(lastA.length>0){ let current=lastA[lastA.length-1], streak=1;
    for(let i=lastA.length-2;i>=0;i--){if(lastA[i]===current) streak++; else break;}
    document.getElementById("streakAggr").innerText=(current?"é€£è´ ":"é€£è¼¸ ")+streak+"æœŸ";
  }

  // æœ€è¿‘20 & 50å±€å‹ç‡
  document.getElementById("winRateCons").innerText=
    "æœ€è¿‘20å±€å‹ç‡ï¼š"+calcRecent(resultsC,20).toFixed(1)+"% | æœ€è¿‘50å±€å‹ç‡ï¼š"+calcRecent(resultsC,50).toFixed(1)+"%";
  document.getElementById("winRateAggr").innerText=
    "æœ€è¿‘20å±€å‹ç‡ï¼š"+calcRecent(resultsA,20).toFixed(1)+"% | æœ€è¿‘50å±€å‹ç‡ï¼š"+calcRecent(resultsA,50).toFixed(1)+"%";
}

function calcRecent(arr,n){
  const slice=arr.slice(-n);
  if(!slice.length) return 0;
  return slice.filter(x=>x).length/slice.length*100;
}

/* ===================
   è¨ˆç®—æµç¨‹
=================== */
function calculate(){
  calculateSpecial();
  calculateBigSmall();
  updateTrendBoxes();

  document.getElementById("history").innerText=
    rounds.slice(-30).map(r=>`${r.d1}${r.d2}${r.d3}${r.isSpecial?'â˜…':''}`).join(" , ");
}

/* ===================
   è¶¨å‹¢é•·åº¦åˆ‡æ›
=================== */
function setTrend(n){
  trendLength=n;
  document.getElementById("btn20").classList.remove("active");
  document.getElementById("btn40").classList.remove("active");
  document.getElementById("btn"+n).classList.add("active");
  updateTrendBoxes();
}

/* ===================
   ç¹ªåœ–
=================== */
function drawChart(){
  chart.setOption({
    xAxis:{type:'category',data:specialProbs.map((_,i)=>i+1)},
    yAxis:{type:'value'},
    series:[{data:specialProbs,type:'line',smooth:true}]
  });
}
</script>
</body>
</html>
