<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>三骰專業分析器</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
body{background:#0f172a;color:#e5e7eb;font-family:Arial;text-align:center;}
.container{max-width:1100px;margin:auto;padding:20px;}
.dice-btn{
  width:50px;height:50px;margin:5px;
  font-size:18px;border-radius:8px;border:none;
  cursor:pointer;background:#1e293b;color:white;
}
.card{
  background:#1e293b;padding:20px;
  margin-top:20px;border-radius:12px;
}
.prob{font-size:34px;font-weight:bold;}
.big{color:#f87171;font-size:22px;}
.small{color:#38bdf8;font-size:22px;}
.stat{font-size:14px;color:#94a3b8;}
</style>
</head>
<body>

<div class="container">
<h1>三骰專業分析器</h1>

<div class="card">
<h3>選擇三顆骰子</h3>
<div id="diceButtons"></div>
<div style="margin-top:10px;">已選：<span id="selectedDice"></span></div>
<button onclick="submitRound()" style="margin-top:15px;padding:10px 20px;">確認新增</button>
</div>

<div class="card">
<h3>特殊機率（豹子+17）</h3>
<div id="specialProb" class="prob">4.17%</div>
<div id="gapInfo"></div>
<div id="weights"></div>
</div>

<div class="card">
<h3>大小預測</h3>
<div id="bigSmall"></div>
<div class="stat">大小預測準確率：<span id="accuracy">0%</span></div>
</div>

<div class="card">
<h3>最近30局</h3>
<div id="history"></div>
</div>

<div class="card">
<h3>機率走勢</h3>
<div id="chart" style="height:300px;"></div>
</div>

</div>

<script>
const BASE_SPECIAL=0.0417;
const BASE_BIG=0.486;
const BASE_SMALL=0.486;

let rounds=[];
let selected=[];
let specialProbs=[];
let bigSmallPredictions=[];
let correctCount=0;

function createButtons(){
  const container=document.getElementById("diceButtons");
  for(let i=1;i<=6;i++){
    const btn=document.createElement("button");
    btn.innerText=i;
    btn.className="dice-btn";
    btn.onclick=()=>selectDice(i);
    container.appendChild(btn);
  }
}
createButtons();

function selectDice(num){
  if(selected.length<3){
    selected.push(num);
    document.getElementById("selectedDice").innerText=selected.join(" , ");
  }
}

function submitRound(){
  if(selected.length!==3){
    alert("請選三顆");
    return;
  }

  const [d1,d2,d3]=selected;
  const sum=d1+d2+d3;
  const isBao=(d1===d2&&d2===d3);
  const is17=(sum===17);
  const isSpecial=isBao||is17;

  const size=sum>=11?"大":"小";

  // 驗證上一把預測是否命中
  if(bigSmallPredictions.length>0){
    const lastPred=bigSmallPredictions[bigSmallPredictions.length-1];
    if(lastPred===size) correctCount++;
  }

  rounds.push({d1,d2,d3,sum,isSpecial,size});
  selected=[];
  document.getElementById("selectedDice").innerText="";

  calculate();
}

function getGap(){
  for(let i=rounds.length-1;i>=0;i--){
    if(rounds[i].isSpecial){
      return rounds.length-1-i;
    }
  }
  return rounds.length;
}

function intervalWeight(gap){
  const peaks=[1,3,5,10,14,16,18];
  let w=1;
  peaks.forEach(p=>{
    const diff=Math.abs(gap-p);
    w+=Math.exp(-(diff*diff)/8)*0.6;
  });
  return w;
}

function densityWeight(){
  const last=rounds.slice(-3);
  if(last.length===0) return 1;
  const freq=[0,0,0,0,0,0];
  last.forEach(r=>{
    freq[r.d1-1]++;
    freq[r.d2-1]++;
    freq[r.d3-1]++;
  });
  const mean=freq.reduce((a,b)=>a+b)/6;
  const variance=freq.reduce((a,b)=>a+(b-mean)**2,0)/6;
  const std=Math.sqrt(variance);
  return 1+std*0.15;
}

function structureWeight(){
  if(rounds.length===0) return 1;
  const last=rounds[rounds.length-1];
  const arr=[last.d1,last.d2,last.d3];
  const set=new Set(arr);
  let w=1;
  if(set.size===2){
    arr.sort((a,b)=>a-b);
    if(Math.abs(arr[2]-arr[0])>=3) w+=0.2;
  }
  if(set.size===1){ w+=0.4; }
  return w;
}

// 改良大小平衡模型
function bigSmallTrend(){
  const last=rounds.slice(-20);
  let big=0,small=0;

  last.forEach(r=>{
    if(r.size==="大") big++;
    if(r.size==="小") small++;
  });

  const total=big+small;
  if(total===0) return {bigProb:BASE_BIG,smallProb:BASE_SMALL};

  const ratio=(big-small)/total;

  // 均值回歸因子 0.5
  const adjustedBias=ratio*0.05*0.5;

  let bigProb=BASE_BIG+adjustedBias;
  let smallProb=BASE_SMALL-adjustedBias;

  return {bigProb,smallProb};
}

function calculate(){
  const gap=getGap();
  const w1=intervalWeight(gap);
  const w2=densityWeight();
  const w3=structureWeight();

  let special=BASE_SPECIAL*w1*w2*w3;
  if(special>0.12) special=0.12;

  specialProbs.push((special*100).toFixed(2));

  document.getElementById("specialProb").innerText=
    (special*100).toFixed(2)+"%";

  document.getElementById("gapInfo").innerText=
    "距離上次特殊局數："+gap;

  document.getElementById("weights").innerText=
    "Interval x"+w1.toFixed(2)+
    " | Density x"+w2.toFixed(2)+
    " | Structure x"+w3.toFixed(2);

  const trend=bigSmallTrend();
  let prediction=trend.bigProb>trend.smallProb?"大":"小";
  bigSmallPredictions.push(prediction);

  document.getElementById("bigSmall").innerHTML=
    `<div class="${prediction==="大"?"big":"small"}">
      預測：${prediction}
     </div>
     <div>大 ${(trend.bigProb*100).toFixed(1)}% | 小 ${(trend.smallProb*100).toFixed(1)}%</div>`;

  const totalPred=bigSmallPredictions.length-1;
  const acc=totalPred>0?(correctCount/totalPred*100).toFixed(1):0;
  document.getElementById("accuracy").innerText=acc+"%";

  document.getElementById("history").innerText=
    rounds.slice(-30)
    .map(r=>`${r.d1}${r.d2}${r.d3}${r.isSpecial?'★':''}`)
    .join(" , ");

  drawChart();
}

function drawChart(){
  const chart=echarts.init(document.getElementById('chart'));
  chart.setOption({
    xAxis:{type:'category',data:specialProbs.map((_,i)=>i+1)},
    yAxis:{type:'value'},
    series:[{data:specialProbs,type:'line',smooth:true}]
  });
}
</script>

</body>
</html>