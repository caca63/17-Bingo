<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>三骰特殊機率分析器</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
body{
  background:#0f172a;
  color:#e5e7eb;
  font-family:Arial;
  text-align:center;
}
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
input{
  width:60px;
  height:40px;
  font-size:20px;
  text-align:center;
}
button{
  padding:10px 20px;
  font-size:16px;
  margin-top:10px;
  cursor:pointer;
}
.card{
  background:#1e293b;
  padding:20px;
  margin-top:20px;
  border-radius:12px;
}
.prob{
  font-size:40px;
  font-weight:bold;
}
.low{color:#38bdf8;}
.mid{color:#facc15;}
.high{color:#f87171;}
</style>
</head>
<body>
<div class="container">
<h1>三骰特殊機率分析器</h1>

<div class="card">
<input id="d1" type="number" min="1" max="6">
<input id="d2" type="number" min="1" max="6">
<input id="d3" type="number" min="1" max="6">
<br>
<button onclick="addRound()">新增一局</button>
</div>

<div class="card">
<div>預測機率</div>
<div id="prob" class="prob">4.17%</div>
<div id="reason"></div>
</div>

<div class="card">
<div>距離上次特殊局數：<span id="gap">0</span></div>
</div>

<div class="card">
<h3>最近30局</h3>
<div id="history"></div>
</div>

<div class="card">
<h3>機率走勢</h3>
<div id="chart" style="height:300px;"></div>
</div>

</div>

<script>
const BASE_PROB = 0.0417;
let rounds = [];
let probs = [];

function isBao(d1,d2,d3){
  return d1===d2 && d2===d3;
}

function is17(d1,d2,d3){
  return (d1+d2+d3)===17;
}

function getGap(){
  for(let i=rounds.length-1;i>=0;i--){
    if(rounds[i].isSpecial){
      return rounds.length-1-i;
    }
  }
  return rounds.length;
}

function intervalWeight(gap){
  const peaks=[1,3,5,10,14,16,18];
  let w=1;
  peaks.forEach(p=>{
    const diff=Math.abs(gap-p);
    w+=Math.exp(-(diff*diff)/8)*0.6;
  });
  return w;
}

function densityWeight(){
  const last=rounds.slice(-3);
  if(last.length===0) return 1;

  const freq=[0,0,0,0,0,0];
  last.forEach(r=>{
    freq[r.d1-1]++;
    freq[r.d2-1]++;
    freq[r.d3-1]++;
  });

  const mean=freq.reduce((a,b)=>a+b)/6;
  const variance=freq.reduce((a,b)=>a+(b-mean)**2,0)/6;
  const std=Math.sqrt(variance);

  return 1+std*0.15;
}

function structureWeight(){
  if(rounds.length===0) return 1;
  const last=rounds[rounds.length-1];
  const arr=[last.d1,last.d2,last.d3];
  const set=new Set(arr);
  let w=1;

  if(set.size===2){
    arr.sort((a,b)=>a-b);
    if(Math.abs(arr[2]-arr[0])>=3) w+=0.2;
  }

  if(set.size===1){
    w+=0.4;
  }

  return w;
}

function calculate(){
  const gap=getGap();
  const w1=intervalWeight(gap);
  const w2=densityWeight();
  const w3=structureWeight();

  let prob=BASE_PROB*w1*w2*w3;
  if(prob>0.12) prob=0.12;

  return {prob,w1,w2,w3,gap};
}

function addRound(){
  const d1=parseInt(document.getElementById("d1").value);
  const d2=parseInt(document.getElementById("d2").value);
  const d3=parseInt(document.getElementById("d3").value);

  if(!d1||!d2||!d3||d1>6||d2>6||d3>6){
    alert("請輸入1~6");
    return;
  }

  const special=isBao(d1,d2,d3)||is17(d1,d2,d3);

  rounds.push({d1,d2,d3,isSpecial:special});

  const result=calculate();
  probs.push((result.prob*100).toFixed(2));

  updateUI(result);
}

function updateUI(result){
  const percent=(result.prob*100).toFixed(2);
  const probDiv=document.getElementById("prob");
  probDiv.innerText=percent+"%";

  probDiv.className="prob";
  if(percent<5) probDiv.classList.add("low");
  else if(percent<8) probDiv.classList.add("mid");
  else probDiv.classList.add("high");

  document.getElementById("gap").innerText=result.gap;

  document.getElementById("reason").innerHTML=
    "Interval x"+result.w1.toFixed(2)+
    " | Density x"+result.w2.toFixed(2)+
    " | Structure x"+result.w3.toFixed(2);

  document.getElementById("history").innerText=
    rounds.slice(-30).map(r=>`${r.d1}${r.d2}${r.d3}${r.isSpecial?'★':''}`).join(" , ");

  drawChart();
}

function drawChart(){
  const chart=echarts.init(document.getElementById('chart'));
  chart.setOption({
    xAxis:{type:'category',data:probs.map((_,i)=>i+1)},
    yAxis:{type:'value'},
    series:[{data:probs,type:'line',smooth:true}]
  });
}
</script>
</body>
</html>