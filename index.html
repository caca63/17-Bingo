<script>

const BASE_SPECIAL=0.0417;
const BASE_BIG=0.5;

let rounds=[];
let selected=[];
let specialProbs=[];
let predictions=[];
let specialIntervals=[];
let lastSpecialIndex=null;
let correctCount=0;
let trendLength=20;

let bankroll=10000;
let baseUnit=100;
let peak=10000;

let chart=echarts.init(document.getElementById('chart'));

function createButtons(){
  const c=document.getElementById("diceButtons");
  for(let i=1;i<=6;i++){
    const b=document.createElement("button");
    b.innerText=i;
    b.className="dice-btn";
    b.onclick=()=>selectDice(i);
    c.appendChild(b);
  }
}
createButtons();

function selectDice(n){
  if(selected.length<3){
    selected.push(n);
    document.getElementById("selectedDice").innerText=selected.join(",");
  }
}

function submitRound(){
  if(selected.length!==3){alert("請選三顆");return;}

  const [d1,d2,d3]=selected;
  const sum=d1+d2+d3;
  const isBao=(d1===d2&&d2===d3);
  const is17=(sum===17);
  const isSpecial=isBao||is17;
  const size=sum>=11?"大":"小";

  if(predictions.length>0){
    const win=predictions[predictions.length-1]===size;
    if(win) correctCount++;
    updateBank(win);
  }

  if(isSpecial){
    if(lastSpecialIndex!==null){
      specialIntervals.push(rounds.length-lastSpecialIndex);
    }
    lastSpecialIndex=rounds.length;
  }

  rounds.push({d1,d2,d3,sum,isSpecial,size});
  selected=[];
  document.getElementById("selectedDice").innerText="";
  calculate();
}

function getGap(){
  if(lastSpecialIndex===null) return rounds.length;
  return rounds.length-1-lastSpecialIndex;
}

/* ===========================
   大小盤型判斷 + 雙向動量
=========================== */

function calculateBigSmall(){

  let score=0;
  const last10=rounds.slice(-10);

  if(last10.length>=6){

    const seq=last10.map(r=>r.size==="大"?1:0);

    // 最大連續
    let maxRun=1, run=1;
    for(let i=1;i<seq.length;i++){
      if(seq[i]===seq[i-1]){ run++; maxRun=Math.max(maxRun,run); }
      else run=1;
    }

    if(maxRun>=4){
      score += seq[seq.length-1]===1?0.35:-0.35;
    }

    // 震盪盤偵測
    let flip=0;
    for(let i=1;i<seq.length;i++){
      if(seq[i]!==seq[i-1]) flip++;
    }

    if(flip>=6){
      // 延續交替
      score += seq[seq.length-1]===1?-0.28:0.28;
    }

    // 結構比例偏移
    const bigCount=seq.filter(x=>x===1).length;
    score += (bigCount-seq.length/2)*0.035;
  }

  let bigProb=BASE_BIG+score;

  if(bigProb>0.78) bigProb=0.78;
  if(bigProb<0.22) bigProb=0.22;

  let smallProb=1-bigProb;

  const prediction=bigProb>smallProb?"大":"小";
  predictions.push(prediction);

  document.getElementById("bigSmall").innerHTML=
    `<div class="${prediction==="大"?"big":"small"}">
     預測：${prediction}
     </div>
     <div>大 ${(bigProb*100).toFixed(1)}% | 小 ${(smallProb*100).toFixed(1)}%</div>`;

  const total=predictions.length-1;
  const acc=total>0?(correctCount/total*100).toFixed(1):0;
  document.getElementById("accuracy").innerText=acc+"%";

  updateTrendBoxes();
}

/* ===========================
   特殊機率強化版
=========================== */

function calculateSpecial(){

  const gap=getGap();
  let weight=1;

  // 週期尖峰
  [1,3,5,10,14,16,18].forEach(p=>{
    weight+=Math.exp(-((gap-p)**2)/7)*0.75;
  });

  if(gap>20){
    weight+=0.4+(gap-20)*0.03;
  }

  if(gap<3) weight*=0.8;

  /* ---- 近三局 2221 / 3321 / 333 強化 ---- */

  const last3=rounds.slice(-3);
  if(last3.length===3){

    const typeArr=last3.map(r=>{
      const map={};
      [r.d1,r.d2,r.d3].forEach(n=>map[n]=(map[n]||0)+1);
      const vals=Object.values(map);
      if(vals.includes(3)) return 3;
      if(vals.includes(2)) return 2;
      return 1;
    });

    const triple=typeArr.filter(x=>x===3).length;
    const dbl=typeArr.filter(x=>x===2).length;

    if(triple===3) weight+=1.2;          // 333
    else if(triple===2&&dbl===1) weight+=0.95; // 3321
    else if(dbl===3) weight+=0.75;       // 2221
    else if(dbl===2) weight+=0.4;
  }

  // 過熱弱化
  const recent=specialProbs.slice(-8).map(p=>parseFloat(p));
  if(recent.length>=5){
    const avg=recent.reduce((a,b)=>a+b,0)/recent.length;
    if(avg>9) weight*=0.85;
  }

  const recentSpecial=rounds.slice(-6).filter(r=>r.isSpecial).length;
  if(recentSpecial>=2) weight*=0.8;

  let prob=BASE_SPECIAL*weight;

  if(prob>0.165) prob=0.165;
  if(prob<0.025) prob=0.025;

  specialProbs.push((prob*100).toFixed(2));

  let color="cold";
  if(prob>0.115) color="hot";
  else if(prob>0.075) color="warm";

  const el=document.getElementById("specialProb");
  el.className="prob "+color;
  el.innerText=(prob*100).toFixed(2)+"%";

  document.getElementById("gapInfo").innerText="目前間隔："+gap;
  document.getElementById("gapHistory").innerText=
    "歷史間隔："+specialIntervals.slice(-10).reverse().join(" → ");

  drawChart();
}

/* =========================== */

function calculate(){
  calculateSpecial();
  calculateBigSmall();

  document.getElementById("history").innerText=
    rounds.slice(-30)
    .map(r=>`${r.d1}${r.d2}${r.d3}${r.isSpecial?'★':''}`)
    .join(" , ");
}

function updateBank(win){
  let bet=Math.floor(bankroll*0.02/baseUnit)*baseUnit;
  if(bet<baseUnit) bet=baseUnit;

  if(win) bankroll+=bet;
  else bankroll-=bet;

  if(bankroll>peak) peak=bankroll;

  let drawdown=((peak-bankroll)/peak*100).toFixed(2);

  document.getElementById("bankrollInfo").innerText=
    `資金：${bankroll} | 本注：${bet} | 最大回撤：${drawdown}%`;
}

function setTrend(n){
  trendLength=n;
  document.getElementById("btn20").classList.remove("active");
  document.getElementById("btn40").classList.remove("active");
  document.getElementById("btn"+n).classList.add("active");
  updateTrendBoxes();
}

function updateTrendBoxes(){
  const container=document.getElementById("trendBoxes");
  container.innerHTML="";
  let results=[];

  for(let i=1;i<rounds.length;i++){
    results.push(predictions[i-1]===rounds[i].size);
  }

  const last=results.slice(-trendLength);
  last.forEach(win=>{
    const box=document.createElement("div");
    box.className=win?"win":"lose";
    container.appendChild(box);
  });

  if(last.length>0){
    let current=last[last.length-1];
    let streak=1;
    for(let i=last.length-2;i>=0;i--){
      if(last[i]===current) streak++;
      else break;
    }
    document.getElementById("streakInfo").innerText=
      (current?"連贏 ":"連輸 ")+streak+" 期";
  }
}

function drawChart(){
  chart.setOption({
    xAxis:{type:'category',data:specialProbs.map((_,i)=>i+1)},
    yAxis:{type:'value'},
    series:[{data:specialProbs,type:'line',smooth:true}]
  });
}

</script>
